<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TinyLlama Chat</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: sans-serif; background: #f0f0f0; height: 100vh; display: flex; flex-direction: column; }
    #header { background: #2c3e50; color: white; padding: 12px 16px; font-size: 18px; font-weight: bold; }
    #status { background: #f39c12; color: white; padding: 8px 16px; font-size: 13px; text-align: center; }
    #status.ready { background: #27ae60; }
    #chat { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .bubble { max-width: 85%; padding: 10px 14px; border-radius: 16px; font-size: 15px; line-height: 1.5; }
    .user { background: #2c3e50; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .bot { background: white; color: #222; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .thinking { color: #999; font-style: italic; }
    #inputarea { background: white; padding: 12px; display: flex; gap: 8px; border-top: 1px solid #ddd; }
    #input { flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; font-size: 15px; outline: none; }
    #sendbtn { background: #2c3e50; color: white; border: none; border-radius: 20px; padding: 10px 20px; font-size: 15px; cursor: pointer; }
    #sendbtn:disabled { background: #aaa; cursor: not-allowed; }

    /* Loading overlay */
    #overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 999; color: white; text-align: center; padding: 30px;
    }
    #overlay.hidden { display: none; }

    .spinner {
      width: 80px; height: 80px;
      border: 8px solid rgba(255,255,255,0.2);
      border-top: 8px solid #f39c12;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 24px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #overlay h2 { font-size: 22px; margin-bottom: 10px; }
    #overlay p { font-size: 14px; color: #ccc; margin-bottom: 20px; }

    #progressbar-wrap {
      width: 100%; max-width: 320px;
      background: rgba(255,255,255,0.15);
      border-radius: 20px; height: 12px; overflow: hidden; margin-bottom: 12px;
    }
    #progressbar {
      height: 100%; width: 0%;
      background: #f39c12;
      border-radius: 20px;
      transition: width 0.3s ease;
    }
    #progresstext { font-size: 13px; color: #f39c12; margin-bottom: 6px; }
    #timer { font-size: 28px; font-weight: bold; color: white; margin-top: 10px; }
    #timerlabel { font-size: 12px; color: #aaa; margin-top: 4px; }
  </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="overlay">
  <div class="spinner"></div>
  <h2>ü¶ô Loading TinyLlama AI</h2>
  <p>Downloading model (~600MB)<br>Only needed once ‚Äî cached after this</p>
  <div id="progressbar-wrap">
    <div id="progressbar"></div>
  </div>
  <div id="progresstext">Starting download‚Ä¶</div>
  <div id="timer">0:00</div>
  <div id="timerlabel">elapsed time</div>
</div>

<div id="header">ü¶ô TinyLlama Chat</div>
<div id="status">‚è≥ Loading AI model‚Ä¶</div>
<div id="chat"></div>
<div id="inputarea">
  <input id="input" type="text" placeholder="Ask anything‚Ä¶" disabled />
  <button id="sendbtn" disabled>Send</button>
</div>

<script type="module">
  import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

  const statusEl = document.getElementById('status');
  const chatEl = document.getElementById('chat');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('sendbtn');
  const overlay = document.getElementById('overlay');
  const progressBar = document.getElementById('progressbar');
  const progressText = document.getElementById('progresstext');
  const timerEl = document.getElementById('timer');

  let generator;
  let history = [];
  let seconds = 0;

  // Start timer
  const timerInterval = setInterval(() => {
    seconds++;
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    timerEl.textContent = `${m}:${s.toString().padStart(2, '0')}`;
  }, 1000);

  function addBubble(text, role) {
    const div = document.createElement('div');
    div.className = `bubble ${role}`;
    div.textContent = text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
    return div;
  }

  async function loadModel() {
    env.allowLocalModels = false;

    generator = await pipeline('text-generation', 'Xenova/TinyLlama-1.1B-Chat-v1.0', {
      progress_callback: (progress) => {
        if (progress.status === 'downloading') {
          const pct = progress.progress ? Math.round(progress.progress) : 0;
          const loaded = progress.loaded ? (progress.loaded / 1024 / 1024).toFixed(1) : '?';
          const total = progress.total ? (progress.total / 1024 / 1024).toFixed(1) : '?';
          progressBar.style.width = pct + '%';
          progressText.textContent = `${pct}% ‚Äî ${loaded} MB of ${total} MB`;
        }
        if (progress.status === 'loading') {
          progressText.textContent = 'Loading into memory‚Ä¶';
          progressBar.style.width = '100%';
        }
      }
    });

    clearInterval(timerInterval);
    overlay.classList.add('hidden');
    statusEl.textContent = '‚úÖ Ready! Ask me anything.';
    statusEl.className = 'ready';
    inputEl.disabled = false;
    sendBtn.disabled = false;
    inputEl.focus();
  }

  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) return;

    inputEl.value = '';
    inputEl.disabled = true;
    sendBtn.disabled = true;

    addBubble(text, 'user');
    history.push({ role: 'user', content: text });

    const thinkingBubble = addBubble('Thinking‚Ä¶', 'bot thinking');

    const messages = [
      { role: 'system', content: 'You are a helpful, friendly assistant. Give clear and concise answers.' },
      ...history
    ];

    const result = await generator(messages, {
      max_new_tokens: 300,
      temperature: 0.7,
      repetition_penalty: 1.3,
      do_sample: true,
    });

    const reply = result[0].generated_text.at(-1).content;
    thinkingBubble.textContent = reply;
    thinkingBubble.className = 'bubble bot';

    history.push({ role: 'assistant', content: reply });

    inputEl.disabled = false;
    sendBtn.disabled = false;
    inputEl.focus();
  }

  sendBtn.addEventListener('click', sendMessage);
  inputEl.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

  loadModel();
</script>

</body>
</html>
